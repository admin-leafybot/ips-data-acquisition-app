# API Documentation
## IPS Data Acquisition App - Backend API Specification

**Version**: 2.1  
**Last Updated**: October 2025  
**Status**: Current Implementation

---

## Table of Contents

1. [Overview](#overview)
2. [Base Configuration](#base-configuration)
3. [API Endpoints](#api-endpoints)
4. [Data Models](#data-models)
5. [Database Schema](#database-schema)
6. [Error Handling](#error-handling)
7. [Testing Examples](#testing-examples)
8. [Architecture Notes](#architecture-notes)

---

## Overview

### What This API Does

The IPS Data Acquisition App collects ground truth data for indoor positioning ML models. The backend API receives:

- **Session tracking** - Start/end timestamps for data collection sessions
- **Button presses** - Sequential waypoint markers through building paths
- **IMU sensor data** - 61 sensor parameters from 21 different sensors
- **User data** - Payment status and bonus information

### Key Characteristics

- **Queue-Based**: Mobile app uses local queue, syncs when online
- **Retry Logic**: Exponential backoff on failures
- **Offline-First**: All data stored locally first, then synchronized
- **High Volume**: Expect ~500 IMU data points every 10 seconds per active user

---

## Base Configuration

### Base URL Format

```
https://your-domain.com/api/v1/
```

All endpoints below are relative to this base URL.

### Required Headers

```
Content-Type: application/json
Accept: application/json
```

### Optional Headers (if authentication implemented)

```
Authorization: Bearer {token}
```

### Standard Response Format

All API responses follow this structure:

```json
{
  "success": true | false,
  "message": "Optional human-readable message",
  "data": {} | [] | null
}
```

---

## API Endpoints

### 1. Create Session

**Purpose**: Initialize a new data collection session

**Endpoint**: `POST /sessions/create`

**Request Body**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": 1697587200000
}
```

**Fields**:
- `session_id` (string, required): UUID v4 generated by mobile app
- `timestamp` (number, required): Session start time in Unix milliseconds

**Success Response** (200 OK):
```json
{
  "success": true,
  "message": "Session created successfully",
  "data": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "created_at": 1697587200000
  }
}
```

**Error Responses**:
- `400 Bad Request`: Invalid session_id format or missing fields
- `409 Conflict`: Session ID already exists
- `500 Internal Server Error`: Database error

**Implementation Notes**:
- Store session with `status = 'in_progress'`
- Validate UUID format
- Check for duplicate session_id

---

### 2. Close Session

**Purpose**: Mark a session as completed

**Endpoint**: `POST /sessions/close`

**Request Body**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "end_timestamp": 1697587800000
}
```

**Fields**:
- `session_id` (string, required): UUID of session to close
- `end_timestamp` (number, required): Session end time in Unix milliseconds

**Success Response** (200 OK):
```json
{
  "success": true,
  "message": "Session closed successfully",
  "data": null
}
```

**Error Responses**:
- `404 Not Found`: Session doesn't exist
- `400 Bad Request`: Session already closed
- `500 Internal Server Error`: Database error

**Implementation Notes**:
- Update session `end_timestamp`
- Change status from `in_progress` to `completed`
- Validate end_timestamp > start_timestamp

---

### 3. Submit Button Press

**Purpose**: Record a waypoint in the user's journey

**Endpoint**: `POST /button-presses`

**Request Body**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "action": "ENTERED_RESTAURANT_BUILDING",
  "timestamp": 1697587210000
}
```

**Fields**:
- `session_id` (string, required): Associated session UUID
- `action` (string, required): Button action (see valid actions below)
- `timestamp` (number, required): Time of button press in Unix milliseconds

**Valid Action Values**:
```
ENTERED_RESTAURANT_BUILDING
ENTERED_ELEVATOR
CLIMBING_STAIRS_3_FLOORS
GOING_UP_8_FLOORS_IN_LIFT
REACHED_RESTAURANT_CORRIDOR
REACHED_RESTAURANT
LEFT_RESTAURANT
COMING_DOWN_3_FLOORS
LEFT_RESTAURANT_BUILDING
ENTERED_DELIVERY_BUILDING
REACHED_DELIVERY_CORRIDOR
REACHED_DOORSTEP
LEFT_DOORSTEP
GOING_DOWN_8_FLOORS_IN_LIFT
LEFT_DELIVERY_BUILDING
```

**Success Response** (200 OK):
```json
{
  "success": true,
  "message": "Button press recorded",
  "data": null
}
```

**Error Responses**:
- `400 Bad Request`: Invalid action value
- `404 Not Found`: Session doesn't exist
- `500 Internal Server Error`: Database error

**Implementation Notes**:
- Mobile app sends **one button press at a time** from queue
- Expect sequential calls (not batches)
- Store with exact timestamp from mobile app
- Associate with session_id

**Traffic Pattern**:
- Normal: 1 request per 10-30 seconds per user
- After offline: Burst of 5-20 requests in quick succession
- Consider rate limiting: ~60 requests/minute per user

---

### 4. Upload IMU Data

**Purpose**: Receive batches of high-frequency sensor data

**Endpoint**: `POST /imu-data/upload`

**Request Body**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "data_points": [
    {
      "timestamp": 1697587210100,
      "accel_x": 0.123, "accel_y": 0.456, "accel_z": 9.789,
      "gyro_x": 0.012, "gyro_y": 0.034, "gyro_z": 0.056,
      "mag_x": 23.4, "mag_y": 12.5, "mag_z": 45.6,
      "gravity_x": 0.05, "gravity_y": 0.10, "gravity_z": 9.81,
      "linear_accel_x": 0.073, "linear_accel_y": 0.356, "linear_accel_z": -0.021,
      
      "accel_uncal_x": 0.125, "accel_uncal_y": 0.458, "accel_uncal_z": 9.791,
      "accel_bias_x": 0.002, "accel_bias_y": 0.002, "accel_bias_z": 0.002,
      "gyro_uncal_x": 0.013, "gyro_uncal_y": 0.035, "gyro_uncal_z": 0.057,
      "gyro_drift_x": 0.001, "gyro_drift_y": 0.001, "gyro_drift_z": 0.001,
      "mag_uncal_x": 23.5, "mag_uncal_y": 12.6, "mag_uncal_z": 45.7,
      "mag_bias_x": 0.1, "mag_bias_y": 0.1, "mag_bias_z": 0.1,
      
      "rotation_vector_x": 0.123, "rotation_vector_y": 0.456,
      "rotation_vector_z": 0.789, "rotation_vector_w": 0.234,
      "game_rotation_x": 0.125, "game_rotation_y": 0.458,
      "game_rotation_z": 0.791, "game_rotation_w": 0.236,
      "geomag_rotation_x": 0.122, "geomag_rotation_y": 0.455,
      "geomag_rotation_z": 0.788, "geomag_rotation_w": 0.233,
      
      "pressure": 1013.25,
      "temperature": 22.5,
      "light": 450.0,
      "humidity": 65.0,
      "proximity": 5.0,
      
      "step_counter": 12543,
      "step_detected": true,
      
      "roll": 15.3,
      "pitch": -5.2,
      "yaw": 45.8,
      "heading": 45.8,
      
      "latitude": 37.7749,
      "longitude": -122.4194,
      "altitude": 10.5,
      "gps_accuracy": 5.2,
      "speed": 0.8
    }
  ]
}
```

**Fields**:
- `session_id` (string, nullable): Associated session UUID (can be null if no active session)
- `data_points` (array, required): Array of IMU data readings

**Data Point Structure** (61 parameters total):

| Parameter | Type | Unit | Description | Nullable |
|-----------|------|------|-------------|----------|
| `timestamp` | number | ms | Unix timestamp | ❌ Required |
| **Calibrated Motion** (15 params) |
| `accel_x/y/z` | float | m/s² | Calibrated accelerometer | ❌ Required |
| `gyro_x/y/z` | float | rad/s | Calibrated gyroscope | ❌ Required |
| `mag_x/y/z` | float | μT | Calibrated magnetometer | ❌ Required |
| `gravity_x/y/z` | float | m/s² | Gravity components | ✅ Nullable |
| `linear_accel_x/y/z` | float | m/s² | Linear acceleration | ✅ Nullable |
| **Uncalibrated Sensors** (18 params) |
| `accel_uncal_x/y/z` | float | m/s² | Uncalibrated accel | ✅ Nullable |
| `accel_bias_x/y/z` | float | m/s² | Accelerometer bias | ✅ Nullable |
| `gyro_uncal_x/y/z` | float | rad/s | Uncalibrated gyro | ✅ Nullable |
| `gyro_drift_x/y/z` | float | rad/s | Gyroscope drift | ✅ Nullable |
| `mag_uncal_x/y/z` | float | μT | Uncalibrated mag | ✅ Nullable |
| `mag_bias_x/y/z` | float | μT | Magnetometer bias | ✅ Nullable |
| **Rotation Vectors** (12 params - quaternions) |
| `rotation_vector_x/y/z/w` | float | - | Rotation quaternion | ✅ Nullable |
| `game_rotation_x/y/z/w` | float | - | Game rotation quaternion | ✅ Nullable |
| `geomag_rotation_x/y/z/w` | float | - | Geomag rotation quaternion | ✅ Nullable |
| **Environmental** (5 params) |
| `pressure` | float | hPa | Barometric pressure | ✅ Nullable |
| `temperature` | float | °C | Ambient temperature | ✅ Nullable |
| `light` | float | lux | Light level | ✅ Nullable |
| `humidity` | float | % | Relative humidity | ✅ Nullable |
| `proximity` | float | cm | Proximity distance | ✅ Nullable |
| **Activity** (2 params) |
| `step_counter` | integer | - | Cumulative steps | ✅ Nullable |
| `step_detected` | boolean | - | Step detected this sample | ✅ Nullable |
| **Computed Orientation** (4 params) |
| `roll` | float | degrees | Roll angle | ✅ Nullable |
| `pitch` | float | degrees | Pitch angle | ✅ Nullable |
| `yaw` | float | degrees | Yaw angle | ✅ Nullable |
| `heading` | float | degrees | Compass heading (0-360) | ✅ Nullable |
| **GPS** (5 params) |
| `latitude` | double | degrees | GPS latitude | ✅ Nullable |
| `longitude` | double | degrees | GPS longitude | ✅ Nullable |
| `altitude` | double | meters | GPS altitude | ✅ Nullable |
| `gps_accuracy` | float | meters | GPS accuracy | ✅ Nullable |
| `speed` | float | m/s | GPS speed | ✅ Nullable |

**Success Response** (200 OK):
```json
{
  "success": true,
  "message": "IMU data uploaded successfully",
  "data": {
    "points_received": 500,
    "session_id": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

**Error Responses**:
- `400 Bad Request`: Invalid data format or missing required fields
- `413 Payload Too Large`: Batch size exceeds limit
- `500 Internal Server Error`: Database error

**Implementation Notes**:
- Expect 200-500 data points per request
- Sent every ~10 seconds per active user
- **Many fields will be null** (not all devices have all sensors)
- GPS fields only populated when user slows down
- Use **bulk insert** operations for performance
- Consider **async processing** (accept request, queue for processing)
- Recommend **compression** (gzip) for these large payloads

**Performance Requirements**:
- Accept ~250 KB payloads
- Process within 2 seconds
- Handle 10-100 concurrent uploads
- Use database partitioning or time-series DB

---

### 5. Get Sessions

**Purpose**: Retrieve user's session history with status information

**Endpoint**: `GET /sessions`

**Query Parameters**:
- `page` (integer, optional): Page number, default = 1
- `limit` (integer, optional): Items per page, default = 50, max = 100

**Example Request**:
```
GET /sessions?page=1&limit=20
```

**Success Response** (200 OK):
```json
{
  "success": true,
  "data": [
    {
      "session_id": "550e8400-e29b-41d4-a716-446655440000",
      "start_timestamp": 1697587200000,
      "end_timestamp": 1697587800000,
      "is_synced": true,
      "status": "approved",
      "payment_status": "paid",
      "remarks": null,
      "bonus_amount": 10.50
    },
    {
      "session_id": "550e8400-e29b-41d4-a716-446655440001",
      "start_timestamp": 1697673600000,
      "end_timestamp": 1697674200000,
      "is_synced": true,
      "status": "rejected",
      "payment_status": "unpaid",
      "remarks": "Incomplete data - missing elevator segment",
      "bonus_amount": null
    }
  ]
}
```

**Session Fields**:
- `session_id` (string): UUID
- `start_timestamp` (number): Unix milliseconds
- `end_timestamp` (number | null): Unix milliseconds, null if in progress
- `is_synced` (boolean): Whether synced to backend
- `status` (string): Enum - `in_progress`, `completed`, `approved`, `rejected`
- `payment_status` (string): Enum - `unpaid`, `paid`
- `remarks` (string | null): Rejection reason or notes
- `bonus_amount` (number | null): Bonus earned for this session

**Implementation Notes**:
- Return sessions ordered by `start_timestamp DESC`
- Filter by user if auth is implemented
- Include pagination metadata in response (optional)

---

### 6. Get Bonuses

**Purpose**: Retrieve daily bonus information

**Endpoint**: `GET /bonuses`

**Query Parameters**:
- `start_date` (string, optional): Start date in YYYY-MM-DD format
- `end_date` (string, optional): End date in YYYY-MM-DD format

**Example Request**:
```
GET /bonuses?start_date=2024-10-01&end_date=2024-10-31
```

**Success Response** (200 OK):
```json
{
  "success": true,
  "data": [
    {
      "date": "2024-10-15",
      "amount": 25.00,
      "sessions_completed": 5,
      "description": "Perfect data quality bonus"
    },
    {
      "date": "2024-10-14",
      "amount": 15.00,
      "sessions_completed": 3,
      "description": "Daily completion bonus"
    }
  ]
}
```

**Bonus Fields**:
- `date` (string): Date in YYYY-MM-DD format
- `amount` (number): Bonus amount (decimal, 2 places)
- `sessions_completed` (integer): Number of sessions completed that day
- `description` (string | null): Bonus description

**Implementation Notes**:
- If no date range provided, return last 30 days
- Calculate bonuses based on approved sessions
- Filter by user if auth is implemented
- Return ordered by `date DESC`

---

## Data Models

### Session

```typescript
{
  session_id: string (UUID v4)
  user_id?: string (if auth implemented)
  start_timestamp: number (Unix milliseconds)
  end_timestamp: number | null
  is_synced: boolean
  status: "in_progress" | "completed" | "approved" | "rejected"
  payment_status: "unpaid" | "paid"
  remarks: string | null
  bonus_amount: number | null (decimal, 2 places)
}
```

### Button Press

```typescript
{
  id: number (auto-increment)
  session_id: string (UUID v4)
  user_id?: string (if auth implemented)
  action: string (enum - see valid actions)
  timestamp: number (Unix milliseconds)
  is_synced: boolean
  created_at: timestamp
}
```

### IMU Data Point

```typescript
{
  id: number (auto-increment)
  session_id: string | null
  user_id?: string (if auth implemented)
  timestamp: number (Unix milliseconds)
  
  // 61 sensor parameters (see endpoint 4 for full list)
  accel_x/y/z: float
  gyro_x/y/z: float
  mag_x/y/z: float
  // ... all other sensor fields
  
  is_synced: boolean
  created_at: timestamp
}
```

### Bonus

```typescript
{
  date: string (YYYY-MM-DD)
  user_id?: string (if auth implemented)
  amount: number (decimal, 2 places)
  sessions_completed: number (integer)
  description: string | null
}
```

---

## Database Schema

### Complete SQL Schema

```sql
-- Sessions Table
CREATE TABLE sessions (
    session_id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36),
    start_timestamp BIGINT NOT NULL,
    end_timestamp BIGINT,
    is_synced BOOLEAN DEFAULT TRUE,
    status VARCHAR(20) DEFAULT 'in_progress',
    payment_status VARCHAR(20) DEFAULT 'unpaid',
    remarks TEXT,
    bonus_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_start_timestamp (start_timestamp)
);

-- Button Presses Table
CREATE TABLE button_presses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    session_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36),
    action VARCHAR(50) NOT NULL,
    timestamp BIGINT NOT NULL,
    is_synced BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (session_id) REFERENCES sessions(session_id) ON DELETE CASCADE,
    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_timestamp (timestamp)
);

-- IMU Data Table (66 columns - see SENSOR_DATA_SPECIFICATION.md for complete schema)
CREATE TABLE imu_data (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    session_id VARCHAR(36),
    user_id VARCHAR(36),
    timestamp BIGINT NOT NULL,
    
    -- Calibrated motion (15 fields)
    accel_x FLOAT NOT NULL,
    accel_y FLOAT NOT NULL,
    accel_z FLOAT NOT NULL,
    gyro_x FLOAT NOT NULL,
    gyro_y FLOAT NOT NULL,
    gyro_z FLOAT NOT NULL,
    mag_x FLOAT NOT NULL,
    mag_y FLOAT NOT NULL,
    mag_z FLOAT NOT NULL,
    gravity_x FLOAT,
    gravity_y FLOAT,
    gravity_z FLOAT,
    linear_accel_x FLOAT,
    linear_accel_y FLOAT,
    linear_accel_z FLOAT,
    
    -- Uncalibrated sensors (18 fields)
    accel_uncal_x FLOAT, accel_uncal_y FLOAT, accel_uncal_z FLOAT,
    accel_bias_x FLOAT, accel_bias_y FLOAT, accel_bias_z FLOAT,
    gyro_uncal_x FLOAT, gyro_uncal_y FLOAT, gyro_uncal_z FLOAT,
    gyro_drift_x FLOAT, gyro_drift_y FLOAT, gyro_drift_z FLOAT,
    mag_uncal_x FLOAT, mag_uncal_y FLOAT, mag_uncal_z FLOAT,
    mag_bias_x FLOAT, mag_bias_y FLOAT, mag_bias_z FLOAT,
    
    -- Rotation vectors (12 fields)
    rotation_vector_x FLOAT, rotation_vector_y FLOAT, rotation_vector_z FLOAT, rotation_vector_w FLOAT,
    game_rotation_x FLOAT, game_rotation_y FLOAT, game_rotation_z FLOAT, game_rotation_w FLOAT,
    geomag_rotation_x FLOAT, geomag_rotation_y FLOAT, geomag_rotation_z FLOAT, geomag_rotation_w FLOAT,
    
    -- Environmental (5 fields)
    pressure FLOAT, temperature FLOAT, light FLOAT, humidity FLOAT, proximity FLOAT,
    
    -- Activity (2 fields)
    step_counter INT, step_detected BOOLEAN,
    
    -- Computed orientation (4 fields)
    roll FLOAT, pitch FLOAT, yaw FLOAT, heading FLOAT,
    
    -- GPS (5 fields)
    latitude DOUBLE, longitude DOUBLE, altitude DOUBLE, gps_accuracy FLOAT, speed FLOAT,
    
    is_synced BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (session_id) REFERENCES sessions(session_id) ON DELETE CASCADE,
    INDEX idx_session_timestamp (session_id, timestamp),
    INDEX idx_user_id (user_id)
) PARTITION BY RANGE (timestamp);

-- Bonuses Table
CREATE TABLE bonuses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    date DATE NOT NULL,
    user_id VARCHAR(36),
    amount DECIMAL(10,2) NOT NULL,
    sessions_completed INT NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_user_date (user_id, date),
    INDEX idx_user_id (user_id),
    INDEX idx_date (date)
);
```

**Partitioning Recommendation for IMU Data**:

```sql
-- Partition by month (PostgreSQL/MySQL 8.0+)
CREATE TABLE imu_data_2024_10 PARTITION OF imu_data
    FOR VALUES FROM (1696118400000) TO (1698796800000);

CREATE TABLE imu_data_2024_11 PARTITION OF imu_data
    FOR VALUES FROM (1698796800000) TO (1701388800000);
```

---

## Error Handling

### Standard Error Response Format

```json
{
  "success": false,
  "message": "Human-readable error message",
  "data": null
}
```

### HTTP Status Codes

| Code | Meaning | When to Use |
|------|---------|-------------|
| 200 | OK | Successful request |
| 400 | Bad Request | Invalid input, validation error |
| 401 | Unauthorized | Auth required but not provided |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate resource |
| 413 | Payload Too Large | Request body exceeds limits |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Internal Server Error | Server-side error |

### Example Error Responses

**Validation Error (400)**:
```json
{
  "success": false,
  "message": "Invalid action value. Must be one of: ENTERED_RESTAURANT_BUILDING, ENTERED_ELEVATOR, ...",
  "data": {
    "field": "action",
    "received": "INVALID_ACTION"
  }
}
```

**Not Found (404)**:
```json
{
  "success": false,
  "message": "Session not found",
  "data": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

**Server Error (500)**:
```json
{
  "success": false,
  "message": "Database connection failed. Please try again later.",
  "data": null
}
```

---

## Testing Examples

### Using cURL

**Create Session**:
```bash
curl -X POST https://your-api.com/api/v1/sessions/create \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "timestamp": 1697587200000
  }'
```

**Submit Button Press**:
```bash
curl -X POST https://your-api.com/api/v1/button-presses \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "action": "ENTERED_RESTAURANT_BUILDING",
    "timestamp": 1697587210000
  }'
```

**Upload IMU Data** (minimal example):
```bash
curl -X POST https://your-api.com/api/v1/imu-data/upload \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "data_points": [{
      "timestamp": 1697587210100,
      "accel_x": 0.123, "accel_y": 0.456, "accel_z": 9.789,
      "gyro_x": 0.012, "gyro_y": 0.034, "gyro_z": 0.056,
      "mag_x": 23.4, "mag_y": 12.5, "mag_z": 45.6
    }]
  }'
```

**Close Session**:
```bash
curl -X POST https://your-api.com/api/v1/sessions/close \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "end_timestamp": 1697587800000
  }'
```

**Get Sessions**:
```bash
curl -X GET 'https://your-api.com/api/v1/sessions?page=1&limit=10' \
  -H "Accept: application/json"
```

**Get Bonuses**:
```bash
curl -X GET 'https://your-api.com/api/v1/bonuses?start_date=2024-10-01&end_date=2024-10-31' \
  -H "Accept: application/json"
```

---

## Architecture Notes

### Mobile App Behavior

#### Queue-Based Synchronization

The mobile app uses a **queue-first architecture**:

1. **User Action** → Saved to local queue immediately
2. **Background Service** → Monitors internet connectivity
3. **When Online** → Processes queue sequentially
4. **On Failure** → Stops processing, retries with exponential backoff
5. **On Success** → Continues to next item

#### Sync Patterns

**Button Presses**:
- Stored locally when user clicks
- Sent **one at a time** from queue (not batches)
- Frequency: 1 request per 10-30 seconds normally
- After offline: Burst of 5-20 requests when coming back online

**IMU Data**:
- Collected continuously (100-200 Hz sampling)
- Batched every 5 seconds locally
- Sent in groups of ~500 data points
- Frequency: 1 upload per 10 seconds per active user

**Sessions**:
- Created when first button pressed
- Closed when last button pressed
- Sent independently of button queue

#### Retry Logic

**Exponential Backoff**:
```
Attempt 1: 10 seconds
Attempt 2: 20 seconds
Attempt 3: 40 seconds
Attempt 4: 80 seconds
Attempt 5+: 300 seconds (5 min max)
```

**Recovery**: Resets to 10 seconds on first success or network return

### Performance Considerations

**Expected Load**:
- 10-100 concurrent users
- ~1-2 button presses per minute per user
- ~6 IMU uploads per minute per active user
- Peak: 200-500 IMU data points per upload

**Recommendations**:
1. **IMU Data Endpoint**:
   - Return 200 immediately
   - Queue for async processing
   - Use bulk insert operations
   - Consider time-series database

2. **Rate Limiting**:
   - Button presses: 60 req/min per user
   - IMU uploads: 10 req/min per user
   - GET endpoints: 100 req/min per user

3. **Caching**:
   - Cache user session data
   - Cache bonus calculations
   - Use Redis for active session tracking

4. **Compression**:
   - Enable gzip for IMU uploads
   - Reduces payload ~70%

5. **Database Optimization**:
   - Partition `imu_data` by timestamp
   - Index on session_id and timestamp
   - Use connection pooling

---

## API Endpoints Summary

| # | Method | Endpoint | Purpose | Frequency |
|---|--------|----------|---------|-----------|
| 1 | POST | `/sessions/create` | Start session | Once per session |
| 2 | POST | `/sessions/close` | End session | Once per session |
| 3 | POST | `/button-presses` | Record waypoint | 1-2 per minute |
| 4 | POST | `/imu-data/upload` | Upload sensors | ~6 per minute |
| 5 | GET | `/sessions` | List sessions | On user request |
| 6 | GET | `/bonuses` | Get bonuses | On user request |

**Total**: 6 endpoints

---

**Document Version**: 2.1  
**Status**: ✅ **CURRENT**  
**Based On**: Latest code implementation  
**Last Updated**: October 2025

---

## Related Documentation

- **`SENSOR_DATA_SPECIFICATION.md`** - Complete sensor parameter reference
- **`QUEUE_ARCHITECTURE_SUMMARY.md`** - Mobile app sync architecture
- **`FINAL_UPDATE_SUMMARY.md`** - Complete project overview
- **`SETUP_GUIDE.md`** - Development setup instructions

